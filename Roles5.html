<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Simula‚ÄëICTUS ¬∑ Modo por Roles (L√≠der / Mandao)</title>
<!-- Tailwind CSS desde CDN (CORREGIDO) -->
<script src="https://cdn.tailwindcss.com"></script>

<style>
  /* Fondo degradado animado pastel */
  body{
    background: linear-gradient(135deg,#d0e8ff,#f7d7ff,#ffe7d0);
    background-size:400% 400%;
    animation:fondo 18s ease infinite;
    font-family:'Segoe UI',system-ui,-apple-system,Roboto,"Helvetica Neue",Arial,"Noto Sans","Apple Color Emoji","Segoe UI Emoji";
  }
  @keyframes fondo{ 0%{background-position:0% 50%} 50%{background-position:100% 50%} 100%{background-position:0% 50%} }

  /* Cron√≥metro enorme */
  #tiempo{ font-size:7rem; font-weight:900; text-shadow:3px 3px 10px rgba(0,0,0,0.2) }
  .flash{ animation:flashEffect .4s ease-in-out }
  @keyframes flashEffect{ 0%{ background-color:rgba(255,0,0,.5) } 100%{ background-color:transparent } }
  .finalizado{ color:#11a860!important; animation:pulse 1.8s ease-in-out infinite }
  @keyframes pulse{ 0%{ transform:scale(1) } 50%{ transform:scale(1.05) } 100%{ transform:scale(1) } }

  /* Bot√≥n ambulancia (SVG) */
  .amb-btn svg{ width:200px; height:130px }
  .amb-btn:disabled{ opacity:.5; pointer-events:none }
  .amb-btn:hover{ transform: scale(1.03) }
  .light-blink{ animation: blink 1.1s infinite }
  @keyframes blink{ 0%,100%{opacity:1} 50%{opacity:.25} }

  /* Cerebro (hero) */
  .brain svg{ width:150px; height:150px; filter: drop-shadow(0 10px 16px rgba(0,0,0,.15)) }
  .drip{ animation: drip 2.8s ease-in-out infinite }
  @keyframes drip{ 0%{ transform: translateY(0px) } 50%{ transform: translateY(6px) } 100%{ transform: translateY(0px) } }

  /* Emojis */
  .emoji-btn{ font-size:4.2rem; line-height:1; cursor:pointer; transition: transform .2s, filter .2s; user-select:none }
  .emoji-btn:hover{ transform:scale(1.08); filter:drop-shadow(0 6px 10px rgba(0,0,0,.15)) }

  /* Overlays */
  #gameOverOverlay, #successOverlay{
    position:fixed; inset:0; background:rgba(0,0,0,.82);
    display:none; align-items:center; justify-content:center; z-index:9999;
  }
  .go-text{
    color:#ff4d4f; font-size:min(18vw,150px); font-weight:900; text-align:center; line-height:1.1;
    text-shadow:0 0 30px rgba(255,77,79,.6);
  }
  .go-sub{ color:#fff; font-size:min(5vw,28px); margin-top:10px }
  .ok-text{
    color:#22c55e; font-size:min(18vw,150px); font-weight:900; text-align:center; line-height:1.1;
    text-shadow:0 0 30px rgba(34,197,94,.6);
  }
  .ok-sub{ color:#fff; font-size:min(5vw,28px); margin-top:10px }
</style>
</head>

<body class="p-6">
  <div class="max-w-6xl mx-auto bg-white/70 backdrop-blur-xl p-8 rounded-3xl shadow-2xl space-y-8 border border-white/40">

    <!-- Cabecera / Nombre + Selector de caso -->
    <div class="flex flex-wrap items-center justify-between gap-3">
      <div class="flex items-center gap-4">
        <div class="brain">
          <!-- Cerebro -->
          <svg viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
            <defs><linearGradient id="g1" x1="0" x2="1" y1="0" y2="1"><stop offset="0%" stop-color="#ff99b3"/><stop offset="100%" stop-color="#ff6f91"/></linearGradient></defs>
            <ellipse cx="100" cy="85" rx="70" ry="55" fill="url(#g1)" stroke="#c13b63" stroke-width="3"/>
            <path d="M50,90 C70,70 130,70 150,90" fill="none" stroke="#c13b63" stroke-width="3"/>
            <path d="M60,105 C80,85 120,85 140,105" fill="none" stroke="#c13b63" stroke-width="3"/>
            <path d="M70,75 C85,65 115,65 130,75" fill="none" stroke="#c13b63" stroke-width="3"/>
            <path class="drip" d="M85,115 c5,20 -5,25 -5,40 c0,5 8,5 8,0 c0,-12 8,-18 5,-35z" fill="#ff6f91" opacity="0.9"/>
            <path class="drip" style="animation-delay:.6s" d="M120,110 c6,18 -6,24 -6,36 c0,5 8,5 8,0 c0,-9 8,-15 5,-30z" fill="#ff6f91" opacity="0.85"/>
          </svg>
        </div>
        <div>
          <h1 class="text-5xl font-extrabold text-blue-900 tracking-tight">Simula‚ÄëICTUS</h1>
          <p class="text-gray-700">Modo por roles: <span class="font-semibold">L√≠der</span> y <span class="font-semibold">Mandao</span></p>
        </div>
      </div>

      <!-- Selector de caso -->
      <div class="text-right">
        <label class="text-sm text-gray-600 block mb-1">Ir a caso:</label>
        <select id="casePicker" class="border rounded px-3 py-2 bg-white/90"></select>
        <div class="text-xs text-gray-600 mt-1">
          Caso actual: <span id="caseNumber" class="font-bold text-blue-800">#1</span> / <span id="caseTotal">‚Äî</span>
        </div>
      </div>
    </div>

    <!-- Objetivo y Normas (primero) -->
    <div class="bg-white/80 border p-5 rounded-xl">
      <h2 class="text-2xl font-extrabold text-gray-800 mb-2">üéØ Objetivo</h2>
      <p class="text-gray-800 mb-4">
        Resolver cada caso en el <strong>menor tiempo posible</strong> tomando decisiones correctas sobre el <strong>C√≥digo Ictus</strong>.
        El tiempo que se valora es <strong>el del L√≠der</strong>. Deb√©is trabajar en <strong>equipo</strong>.
      </p>
      <h3 class="text-xl font-bold text-gray-800 mb-1">üìã Normas</h3>
      <ul class="list-disc pl-6 text-gray-800 space-y-1">
        <li><strong>L√≠der:</strong> explora <em>Paciente</em> y <em>Hora de inicio</em>; introduce el valor num√©rico de <em>Madrid Direct</em>; decide <em>Cumple/No cumple</em> y, si procede, <em>gestiona la alerta hospitalaria</em>.</li>
        <li><strong>Mandao:</strong> obtiene <em>Monitorizaci√≥n</em> y <em>Antecedentes</em>, realiza la <em>exploraci√≥n por √≠tems de Madrid Direct</em> y ve la <em>puntuaci√≥n calculada</em> para contrastar con el L√≠der.</li>
        <li>El L√≠der debe <em>solicitar</em> al Mandao los datos que necesite; evitad dar pistas innecesarias.</li>
        <li>Al finalizar (acierto o error), pasar√©is autom√°ticamente al <strong>siguiente caso</strong>.</li>
      </ul>
    </div>

    <!-- Selecci√≥n de rol (centrado) -->
    <div class="flex flex-col items-center gap-4 bg-gradient-to-br from-pink-50 via-fuchsia-50 to-sky-50 border border-sky-200 p-6 rounded-xl">
      <div class="flex flex-wrap items-center justify-center gap-3">
        <button id="btnRolLider" class="text-lg bg-emerald-600 hover:bg-emerald-700 text-white px-6 py-3 rounded-xl font-semibold shadow">üß≠ L√≠der</button>
        <button id="btnRolMandao" class="text-lg bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-3 rounded-xl font-semibold shadow">üß∞ Mandao</button>
      </div>
      <div class="text-sm text-gray-600">Rol seleccionado: <span id="rolActual" class="font-bold text-blue-800">‚Äî</span></div>
    </div>

    <!-- Aviso 112 -->
    <div class="bg-blue-50 border border-blue-200 p-5 rounded-xl shadow">
      <h2 class="font-bold text-2xl text-blue-700 mb-2">Aviso entrante del 112</h2>
      <p id="textoCaso" class="text-blue-900 text-lg"></p>
    </div>

    <!-- Bot√≥n de inicio: Ambulancia -->
    <div class="flex flex-col items-center">
      <button id="btnMovilizar" class="amb-btn transition p-3 rounded-xl bg-white/70 border hover:shadow-lg disabled:opacity-50" aria-label="Iniciar simulaci√≥n" title="Iniciar simulaci√≥n" disabled>
        <!-- Dibujo ambulancia estilo SUMMA112 -->
        <svg viewBox="0 0 520 260" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
          <ellipse cx="260" cy="230" rx="210" ry="14" fill="#000" opacity="0.12"/>
          <g>
            <path d="M60 180 L60 120 Q65 90 95 90 L330 90 Q355 90 375 105 L445 150 Q460 160 460 180 L460 180 Z"
                  fill="#f5ec3b" stroke="#1f2937" stroke-width="4"/>
            <path d="M330 90 L390 90 Q410 90 425 102 L470 135 Q480 142 474 152 L460 170 L375 105 Q355 90 330 90 Z"
                  fill="#f5ec3b" stroke="#1f2937" stroke-width="4"/>
            <path d="M370 98 L420 98 Q430 98 438 105 L462 128 Q466 132 462 136 L440 154 L390 116 Q380 106 370 98 Z"
                  fill="#98cfff" stroke="#1f2937" stroke-width="3"/>
          </g>
          <rect x="110" y="104" width="72" height="36" rx="4" fill="#98cfff" stroke="#1f2937" stroke-width="3"/>
          <rect x="200" y="104" width="72" height="36" rx="4" fill="#98cfff" stroke="#1f2937" stroke-width="3"/>
          <rect x="85" y="155" width="300" height="16" fill="#2ea44f"/>
          <rect x="85" y="138" width="24" height="16" fill="#2ea44f"/>
          <rect x="120" y="138" width="24" height="16" fill="#2ea44f"/>
          <rect x="155" y="138" width="24" height="16" fill="#2ea44f"/>
          <rect x="190" y="138" width="24" height="16" fill="#2ea44f"/>
          <rect x="225" y="138" width="24" height="16" fill="#2ea44f"/>
          <rect x="85" y="174" width="345" height="12" fill="#e11d48"/>
          <text x="100" y="132" font-size="16" font-weight="700" fill="#1f2937">SUMMA 112</text>
          <text x="100" y="150" font-size="13" font-weight="700" fill="#1f2937">V.I.R.</text>
          <text x="265" y="132" font-size="18" font-weight="800" fill="#1f2937">112</text>
          <circle cx="160" cy="190" r="24" fill="#111827"/><circle cx="160" cy="190" r="10" fill="#6b7280"/>
          <circle cx="355" cy="190" r="24" fill="#111827"/><circle cx="355" cy="190" r="10" fill="#6b7280"/>
          <rect x="348" y="86" width="20" height="10" rx="2" class="light-blink" fill="#3b82f6"/>
        </svg>
        <div class="mt-2 text-sm text-gray-700">Selecciona rol y pulsa la ambulancia para iniciar</div>
      </button>
    </div>

    <!-- Cron√≥metro -->
    <div id="cronometro" class="hidden text-center pt-2">
      <p id="tiempo" class="text-red-600">00:00</p>
      <p class="text-xl font-semibold text-gray-700 mt-2 tracking-wide">EL TIEMPO ES CEREBRO ‚è±Ô∏è</p>
    </div>

    <!-- Panel de EMOJIS -->
    <div id="emojiPanel" class="hidden grid grid-cols-1 lg:grid-cols-2 gap-6 mt-4">

      <!-- Paciente -->
      <div class="bg-white/80 border border-gray-200 rounded-2xl shadow p-4">
        <div class="flex items-start gap-4">
          <div id="btnClinica" class="emoji-btn" title="Paciente">üßë‚Äçü¶≥</div>
          <div class="flex-1">
            <div class="text-lg font-bold text-gray-800">Paciente</div>
            <div id="descClinica" class="text-gray-700 mt-2"><em>En espera‚Ä¶</em></div>
          </div>
        </div>
      </div>

      <!-- Monitorizaci√≥n -->
      <div class="bg-white/80 border border-gray-200 rounded-2xl shadow p-4">
        <div class="flex items-start gap-4">
          <div id="btnConstantes" class="emoji-btn" title="Monitorizaci√≥n">üì∫</div>
          <div class="flex-1">
            <div class="text-lg font-bold text-gray-800">Monitorizaci√≥n</div>
            <div id="descConstantes" class="text-gray-700 mt-2"><em>En espera‚Ä¶</em></div>
          </div>
        </div>
      </div>

      <!-- Antecedentes -->
      <div class="bg-white/80 border border-gray-200 rounded-2xl shadow p-4">
        <div class="flex items-start gap-4">
          <div id="btnAntecedentes" class="emoji-btn" title="Antecedentes">üìò</div>
          <div class="flex-1">
            <div class="text-lg font-bold text-gray-800">Antecedentes</div>
            <div id="descAntecedentes" class="text-gray-700 mt-2"><em>En espera‚Ä¶</em></div>
          </div>
        </div>
      </div>

      <!-- Hora de inicio -->
      <div class="bg-white/80 border border-gray-200 rounded-2xl shadow p-4">
        <div class="flex items-start gap-4">
          <div id="btnHora" class="emoji-btn" title="Hora de inicio">‚è∞</div>
          <div class="flex-1">
            <div class="text-lg font-bold text-gray-800">Hora de inicio</div>
            <div id="descHora" class="text-gray-700 mt-2"><em>En espera‚Ä¶</em></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Historial -->
    <div id="panelInfo" class="hidden space-y-3 bg-yellow-50/70 border border-yellow-300 p-5 rounded-xl shadow-inner"></div>

    <!-- MADRID DIRECT (Mandao: √≠tems + puntuaci√≥n calculada) -->
    <div id="mdItemsSection" class="hidden space-y-4">
      <h3 class="font-bold text-2xl text-blue-800">Madrid Direct (√≠tems) ¬∑ Mandao</h3>
      <div class="bg-white/80 rounded-xl border p-4">
        <div class="font-semibold mb-2">Miembro superior</div>
        <div class="flex flex-wrap gap-2 items-center">
          <button class="tag bg-gray-100 border" data-check="arm_msd">Vence gravedad en MSD</button><span id="arm_msd_res" class="text-sm"></span>
          <button class="tag bg-gray-100 border" data-check="arm_msi">Vence gravedad en MSI</button><span id="arm_msi_res" class="text-sm"></span>
        </div>
      </div>
      <div class="bg-white/80 rounded-xl border p-4">
        <div class="font-semibold mb-2">Miembro inferior</div>
        <div class="flex flex-wrap gap-2 items-center">
          <button class="tag bg-gray-100 border" data-check="leg_mid">Vence gravedad en MID</button><span id="leg_mid_res" class="text-sm"></span>
          <button class="tag bg-gray-100 border" data-check="leg_mii">Vence gravedad en MII</button><span id="leg_mii_res" class="text-sm"></span>
        </div>
      </div>
      <div class="bg-white/80 rounded-xl border p-4">
        <div class="font-semibold mb-2">Mirada</div>
        <div class="flex flex-wrap gap-2 items-center">
          <button class="tag bg-gray-100 border" data-check="gaze">¬øHay desviaci√≥n de la mirada?</button><span id="gaze_res" class="text-sm"></span>
        </div>
      </div>
      <div class="bg-white/80 rounded-xl border p-4">
        <div class="font-semibold mb-2">√ìrdenes / Reconocimiento del d√©ficit</div>
        <div class="flex flex-wrap gap-2 items-center">
          <button class="tag bg-gray-100 border" data-check="obey">¬øObedece √≥rdenes sencillas?</button><span id="obey_res" class="text-sm"></span>
          <button class="tag bg-gray-100 border" data-check="recognize" id="btnRecognize">¬øReconoce el d√©ficit?</button><span id="recognize_res" class="text-sm"></span>
        </div>
        <p class="text-xs text-gray-500 mt-2">Si <strong>no obedece</strong>, el reconocimiento <em>no es valorable</em>.</p>
      </div>
      <div class="bg-green-50 border border-green-200 rounded-xl p-4">
        <p class="text-sm text-gray-700">Puntuaci√≥n Madrid Direct calculada (seg√∫n caso): 
          <span id="mdCalculada" class="font-bold text-green-700">‚Äî</span>
        </p>
      </div>
    </div>

    <!-- MADRID DIRECT (L√≠der: num√©rico) -->
    <div id="mdNumericSection" class="hidden bg-blue-50 border border-blue-200 rounded-xl p-4">
      <label class="font-semibold text-xl">Introduce la <u>puntuaci√≥n total</u> de MADRID DIRECT:</label>
      <div class="mt-2 flex gap-2 items-center">
        <input id="inputMadrid" type="number" class="border p-3 w-40 rounded-xl shadow text-lg" placeholder="n√∫mero"/>
        <button id="btnValidarMadrid" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-3 rounded-xl shadow font-bold">Validar puntuaci√≥n</button>
        <span id="msgMadrid" class="text-lg ml-2"></span>
      </div>
    </div>

    <!-- DECISI√ìN (solo L√≠der) -->
    <div id="decisionesSection" class="hidden bg-white/80 border rounded-xl p-4">
      <div class="font-bold text-lg mb-2">¬øCrees que <span class="underline">cumple</span> criterios de C√≥digo Ictus?</div>
      <div class="flex flex-wrap gap-3">
        <button id="btnCumple" class="bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2 rounded-lg font-semibold">‚úÖ Cumple criterios</button>
        <button id="btnNoCumple" class="bg-rose-600 hover:bg-rose-700 text-white px-4 py-2 rounded-lg font-semibold">‚ùå NO cumple criterios</button>
      </div>
      <p class="text-sm text-gray-600 mt-2">Selecciona una opci√≥n. Si aciertas, ¬°CONSEGUIDO!; si no, GAME OVER.</p>
    </div>

    <!-- Bot√≥n: Gestionar Alerta hospitalaria -->
    <button id="btnAlerta" class="hidden bg-purple-600 hover:bg-purple-700 text-white px-4 py-4 rounded-xl w-full text-xl font-bold shadow-xl">
      Gestionar Alerta hospitalaria (+5:00)
    </button>

    <!-- Destino -->
    <div id="destinoHospital" class="hidden bg-green-100 border border-green-300 p-5 rounded-xl shadow text-center">
      <p id="textoDestino" class="font-semibold text-green-800 text-2xl"></p>
      <p class="italic text-lg mt-1 text-green-700">Simulacro finalizado</p>
    </div>

    <!-- Cr√©ditos actualizados -->
    <div class="text-[11px] text-gray-500 text-right pt-2">
      Simula ICTUS by H√©ctor Sales ¬∑ desarrollado con apoyo de M365 Copilot- Aplicaci√≥n para formaci√≥n de la Comisi√≥n de Neurolog√≠a SUMMA112
    </div>
  </div>

  <!-- GAME OVER Overlay -->
  <div id="gameOverOverlay" class="flex">
    <div class="text-center">
      <div class="go-text">GAME OVER</div>
      <div class="go-sub" id="goMsg">Has fallado en la decisi√≥n.</div>
      <div class="mt-5">
        <button id="btnSiguienteGO" class="bg-white text-gray-900 px-4 py-2 rounded-lg font-semibold">‚û° Siguiente caso</button>
      </div>
    </div>
  </div>

  <!-- SUCCESS Overlay -->
  <div id="successOverlay" class="flex">
    <div class="text-center">
      <div class="ok-text">¬°CONSEGUIDO!</div>
      <div class="ok-sub" id="okMsg">Tiempo total: 00:00</div>
      <div class="mt-5">
        <button id="btnSiguienteOK" class="bg-white text-gray-900 px-4 py-2 rounded-lg font-semibold">‚û° Siguiente caso</button>
      </div>
    </div>
  </div>

<script>
/* ======= Estado general / Roles ======= */
let segundos = 0, intervalo = null, simulacroFinalizado = false;
let role = null;                 // 'lider' | 'mandao'
let currentCase = null, correctMadrid = 0;
let caseIndex = 1;               // 1..N
const LS_KEY_CASE = 'simula_ictus_case_index';

let weakArmSide = null; // 'MSD' | 'MSI' | null
let weakLegSide = null; // 'MID' | 'MII' | null

let mandaoVioMoni = false, mandaoVioAnte = false;

/* ======= Casos (ordenados) ======= */
const casos = [
  { numero:1, tipo:"Compatible con C√≥digo Ictus",
    aviso:(edad)=>`Paciente de ${edad} a√±os con inicio brusco de s√≠ntomas neurol√≥gicos compatibles.`,
    edad:78,
    clinicaTexto:`<strong>Sintomatolog√≠a:</strong> dificultad para articular el lenguaje, p√©rdida brusca de fuerza en un lado del cuerpo y la familia observa que fija la mirada hacia un lado.`,
    antecedentes:`<strong>Comorbilidades:</strong> HTA, dislipemia; no anticoagulado.<br><strong>Situaci√≥n basal:</strong> ABVD: independiente ¬∑ Cognici√≥n: sin deterioro.`,
    constantes:`<strong>Constantes:</strong> TA 182/100 ¬∑ FC 92 ¬∑ SatO‚ÇÇ 95% ¬∑ Glu 118 mg/dL ¬∑ Temp 36.7 ¬∞C<br><strong>ECG:</strong> Ritmo sinusal.`,
    hora:`<strong>Hora de inicio:</strong> ~35-40 min.`,
    md:{ arm:1,leg:1,gaze:1,noObey:1,recNo:0,pas:182 }, cumpleCodigo:true,
    destino:"Unidad de ICTUS ‚Äì Hospital Doce de Octubre"
  },
  { numero:2, tipo:"M√≠mico (metab√≥lico) ‚Äì NO C√ìDIGO",
    aviso:(edad)=>`Paciente de ${edad} a√±os con alteraci√≥n neurol√≥gica aguda potencialmente reversible.`,
    edad:84,
    clinicaTexto:`<strong>Sintomatolog√≠a:</strong> desorientaci√≥n, torpeza leve e inestabilidad para la marcha.`,
    antecedentes:`<strong>Comorbilidades:</strong> DM2 con insulina; HTA controlada.<br><strong>Situaci√≥n basal:</strong> ABVD: precisa ayuda parcial ¬∑ Cognici√≥n: sin deterioro relevante.`,
    constantes:`<strong>Constantes:</strong> TA 150/85 ¬∑ FC 96 ¬∑ SatO‚ÇÇ 97% ¬∑ Glu 42 mg/dL ¬∑ Temp 36.5 ¬∞C<br><strong>ECG:</strong> Sinusal.`,
    hora:`<strong>Hora de inicio:</strong> ~15 min.`,
    md:{ arm:0,leg:0,gaze:0,noObey:0,recNo:0,pas:150 }, cumpleCodigo:false, destino:"NINGUNO"
  },
  { numero:3, tipo:"Inicio >24 h ‚Äì NO C√ìDIGO",
    aviso:(edad)=>`Paciente de ${edad} a√±os con s√≠ntomas neurol√≥gicos iniciados hace m√°s de 24 horas.`,
    edad:73,
    clinicaTexto:`<strong>Sintomatolog√≠a:</strong> torpeza leve de mano y habla pastosa de m√°s de un d√≠a de evoluci√≥n, sin otros cambios relevantes.`,
    antecedentes:`<strong>Comorbilidades:</strong> Tabaquismo activo, dislipemia; no FA conocida.<br><strong>Situaci√≥n basal:</strong> ABVD: independiente ¬∑ Cognici√≥n: sin deterioro.`,
    constantes:`<strong>Constantes:</strong> TA 138/82 ¬∑ FC 78 ¬∑ SatO‚ÇÇ 98% ¬∑ Glu 104 mg/dL ¬∑ Temp 36.6 ¬∞C<br><strong>ECG:</strong> Sinusal.`,
    hora:`<strong>Hora de inicio:</strong> 26 h.`,
    md:{ arm:0,leg:0,gaze:0,noObey:0,recNo:0,pas:138 }, cumpleCodigo:false, destino:"NINGUNO"
  },
  { numero:4, tipo:"Compatible con C√≥digo Ictus",
    aviso:(edad)=>`Paciente de ${edad} a√±os con inicio s√∫bito de s√≠ntomas neurol√≥gicos compatibles.`,
    edad:69,
    clinicaTexto:`<strong>Sintomatolog√≠a:</strong> habla pastosa, sensaci√≥n de inestabilidad y visi√≥n doble de inicio brusco.`,
    antecedentes:`<strong>Comorbilidades:</strong> HTA, exfumador; no anticoagulado.<br><strong>Situaci√≥n basal:</strong> ABVD: independiente ¬∑ Cognici√≥n: sin deterioro.`,
    constantes:`<strong>Constantes:</strong> TA 168/94 ¬∑ FC 84 ¬∑ SatO‚ÇÇ 96% ¬∑ Glu 110 mg/dL ¬∑ Temp 36.6 ¬∞C<br><strong>ECG:</strong> Sinusal.`,
    hora:`<strong>Hora de inicio:</strong> ~60 min.`,
    md:{ arm:0,leg:0,gaze:0,noObey:0,recNo:0,pas:168 }, cumpleCodigo:true,
    destino:"Unidad de ICTUS ‚Äì Hospital Gregorio Mara√±√≥n"
  },
  { numero:5, tipo:"TIA resuelto ‚Äì NO C√ìDIGO",
    aviso:(edad)=>`Paciente de ${edad} a√±os con episodios transitorios compatibles, actualmente asintom√°tico.`,
    edad:74,
    clinicaTexto:`<strong>Sintomatolog√≠a:</strong> episodio breve previo de hormigueo y torpeza fina en una mano, resuelto en la valoraci√≥n.`,
    antecedentes:`<strong>Comorbilidades:</strong> HTA, FA parox√≠stica sin anticoagulaci√≥n actual.<br><strong>Situaci√≥n basal:</strong> ABVD: independiente ¬∑ Cognici√≥n: sin deterioro.`,
    constantes:`<strong>Constantes:</strong> TA 146/88 ¬∑ FC 84 (irregular) ¬∑ SatO‚ÇÇ 98% ¬∑ Glu 102 mg/dL ¬∑ Temp 36.5 ¬∞C<br><strong>ECG:</strong> FA parox√≠stica.`,
    hora:`<strong>Hora de inicio:</strong> 2 h; s√≠ntomas resueltos.`,
    md:{ arm:0,leg:0,gaze:0,noObey:0,recNo:0,pas:146 }, cumpleCodigo:false, destino:"NINGUNO"
  },
  { numero:6, tipo:"Cefalea brusca intensa ‚Äì Compatible",
    aviso:(edad)=>`Paciente de ${edad} a√±os con cefalea s√∫bita intensa y s√≠ntomas vegetativos.`,
    edad:62,
    clinicaTexto:`<strong>Sintomatolog√≠a:</strong> dolor de cabeza de inicio inmediato y muy intenso, con n√°useas y rigidez de nuca.`,
    antecedentes:`<strong>Comorbilidades:</strong> Fumador; HTA mal controlada.<br><strong>Situaci√≥n basal:</strong> ABVD: independiente ¬∑ Cognici√≥n: sin deterioro.`,
    constantes:`<strong>Constantes:</strong> TA 198/106 ¬∑ FC 88 ¬∑ SatO‚ÇÇ 97% ¬∑ Glu 108 mg/dL ¬∑ Temp 36.8 ¬∞C<br><strong>ECG:</strong> Sinusal.`,
    hora:`<strong>Hora de inicio:</strong> 30 min.`,
    md:{ arm:0,leg:0,gaze:0,noObey:0,recNo:0,pas:198 }, cumpleCodigo:true,
    destino:"Unidad de ICTUS ‚Äì Hospital Cl√≠nico San Carlos"
  },
  { numero:7, tipo:"Alta dependencia previa ‚Äì NO C√ìDIGO (cl√≠nica evidente)",
    aviso:(edad)=>`Paciente de ${edad} a√±os con inicio brusco de cl√≠nica neurol√≥gica evidente.`,
    edad:85,
    clinicaTexto:`<strong>Sintomatolog√≠a:</strong> hemiplejia completa de un lado, afasia significativa y desviaci√≥n fija de la mirada.`,
    antecedentes:`<strong>Comorbilidades:</strong> HTA, cardiopat√≠a isqu√©mica.<br><strong>Situaci√≥n basal:</strong> ABVD: necesita ayuda para la mayor√≠a de actividades ¬∑ Cognici√≥n: deterioro cognitivo moderado.`,
    constantes:`<strong>Constantes:</strong> TA 176/98 ¬∑ FC 80 ¬∑ SatO‚ÇÇ 96% ¬∑ Glu 112 mg/dL ¬∑ Temp 36.6 ¬∞C<br><strong>ECG:</strong> Sinusal.`,
    hora:`<strong>Hora de inicio:</strong> ~50 min.`,
    md:{ arm:1,leg:1,gaze:1,noObey:0,recNo:0,pas:176 }, cumpleCodigo:false, destino:"NINGUNO",
    fixedWeakSide:"derecha"
  }
];

/* ======= Tiempo ======= */
function formatearTiempo(seg){ const m=String(Math.floor(seg/60)).padStart(2,'0'); const s=String(seg%60).padStart(2,'0'); return `${m}:${s}`; }
function actualizarTiempo(){ document.getElementById("tiempo").textContent = formatearTiempo(segundos); }
function flashTiempo(){ const c=document.getElementById("cronometro"); c.classList.add("flash"); setTimeout(()=>c.classList.remove("flash"),400); }
function iniciarCronometro(){ if(intervalo) clearInterval(intervalo); intervalo = setInterval(()=>{ if(!simulacroFinalizado){ segundos++; actualizarTiempo(); } },1000); }
function pararCronometro(){ simulacroFinalizado = true; if(intervalo){ clearInterval(intervalo); intervalo=null; } }

/* ======= C√°lculo Madrid DIRECT ======= */
function calcMadridFromCase(c){
  let p = 0;
  p += c.md.arm; p += c.md.leg; p += c.md.gaze;
  if(c.md.noObey===1){ p+=1; } else if(c.md.recNo===1){ p+=1; }
  const pas=c.md.pas;
  if(pas>=180 && pas<=189) p-=1;
  else if(pas>=190 && pas<=199) p-=2;
  else if(pas>=200 && pas<=209) p-=3;
  else if(pas>209) p-=4;
  if(c.edad>=85) p-=(c.edad-85);
  return p;
}

/* ======= UI helpers ======= */
const LS = {
  saveCase(){ localStorage.setItem(LS_KEY_CASE, String(caseIndex)); },
  loadCase(){ const v=localStorage.getItem(LS_KEY_CASE); if(v){ const n=parseInt(v,10); if(!isNaN(n) && n>=1 && n<=casos.length) caseIndex=n; } }
};

function setCaseNumberDisplay(){
  document.getElementById("caseNumber").textContent = `#${caseIndex}`;
  document.getElementById("caseTotal").textContent = casos.length;
  const picker = document.getElementById("casePicker");
  if(picker && picker.value !== String(caseIndex)) picker.value = String(caseIndex);
}
function hideOverlays(){
  document.getElementById("gameOverOverlay").style.display = "none";
  document.getElementById("successOverlay").style.display = "none";
}

function resetUI(){
  pararCronometro(); simulacroFinalizado=false; segundos=0; actualizarTiempo();
  document.getElementById("cronometro").classList.add("hidden");
  document.getElementById("emojiPanel").classList.add("hidden");
  document.getElementById("panelInfo").classList.add("hidden");

  document.getElementById("mdItemsSection").classList.add("hidden");
  document.getElementById("mdNumericSection").classList.add("hidden");
  document.getElementById("decisionesSection").classList.add("hidden");
  document.getElementById("btnAlerta").classList.add("hidden");
  document.getElementById("destinoHospital").classList.add("hidden");
  document.getElementById("textoDestino").textContent = "";

  document.getElementById("descClinica").innerHTML = `<em>En espera‚Ä¶</em>`;
  document.getElementById("descConstantes").innerHTML = `<em>En espera‚Ä¶</em>`;
  document.getElementById("descAntecedentes").innerHTML = `<em>En espera‚Ä¶</em>`;
  document.getElementById("descHora").innerHTML = `<em>En espera‚Ä¶</em>`;

  document.getElementById("panelInfo").innerHTML = "";
  document.getElementById("inputMadrid").value="";
  document.getElementById("msgMadrid").textContent="";
  ["arm_msd_res","arm_msi_res","leg_mid_res","leg_mii_res","gaze_res","obey_res","recognize_res"].forEach(id=>{ const el=document.getElementById(id); if(el) el.textContent=""; });
  document.getElementById("mdCalculada").textContent = "‚Äî";

  hideOverlays();                       /* <- asegura ocultaci√≥n de overlays */
  mandaoVioMoni=false; mandaoVioAnte=false;
  document.getElementById("btnMovilizar").disabled = (role===null);
}

function seleccionarCasoActual(){
  let idx = caseIndex - 1;
  if(idx < 0) idx = 0;
  if(idx >= casos.length) idx = casos.length - 1;
  currentCase = casos[idx];

  weakArmSide = null; weakLegSide = null;
  if(currentCase.md.arm===1 && currentCase.md.leg===1 && currentCase.fixedWeakSide){
    if(currentCase.fixedWeakSide === "derecha"){ weakArmSide='MSD'; weakLegSide='MID'; }
    else { weakArmSide='MSI'; weakLegSide='MII'; }
  } else {
    if(currentCase.md.arm===1){ weakArmSide = Math.random() < 0.5 ? 'MSD' : 'MSI'; }
    if(currentCase.md.leg===1){ weakLegSide = Math.random() < 0.5 ? 'MID' : 'MII'; }
  }

  document.getElementById("textoCaso").textContent = currentCase.aviso(currentCase.edad);
  correctMadrid = calcMadridFromCase(currentCase);
  document.getElementById("mdCalculada").textContent = String(correctMadrid);
}

/* ======= Acciones y gating por rol ======= */
function appendInfo(html){
  const panel = document.getElementById("panelInfo");
  panel.classList.remove("hidden");
  const bloque = document.createElement("div");
  bloque.className = "bg-white p-4 rounded-xl border shadow";
  bloque.innerHTML = html;
  panel.appendChild(bloque);
  segundos += 90; actualizarTiempo(); flashTiempo();
}
function onClinica(){ if(role==='mandao'){ appendInfo(`<em>No corresponde</em> (acci√≥n del <strong>L√≠der</strong>).`); return; } appendInfo(currentCase.clinicaTexto); document.getElementById("descClinica").innerHTML=currentCase.clinicaTexto; }
function onHora(){ if(role==='mandao'){ appendInfo(`<em>No corresponde</em> (acci√≥n del <strong>L√≠der</strong>).`); return; } appendInfo(currentCase.hora); document.getElementById("descHora").innerHTML=currentCase.hora; }
function onConstantes(){ if(role==='lider'){ appendInfo(`<em>Pregunta al <strong>Mandao</strong></em>.`); return; } appendInfo(currentCase.constantes); document.getElementById("descConstantes").innerHTML=currentCase.constantes; mandaoVioMoni=true; maybeShowMandaoItems(); }
function onAntecedentes(){ if(role==='lider'){ appendInfo(`<em>Pregunta al <strong>Mandao</strong></em>.`); return; } appendInfo(currentCase.antecedentes); document.getElementById("descAntecedentes").innerHTML=currentCase.antecedentes; mandaoVioAnte=true; maybeShowMandaoItems(); }
function maybeShowMandaoItems(){ if(role==='mandao' && mandaoVioMoni && mandaoVioAnte){ document.getElementById("mdItemsSection").classList.remove("hidden"); } }

/* √çtems MD (Mandao) */
function setItemResult(spanId, okText, badText, isOK){ const el=document.getElementById(spanId); el.textContent = isOK?okText:badText; el.className = isOK?"text-green-700 font-semibold":"text-red-700 font-semibold"; }
function handleCheck(tag){
  switch(tag){
    case 'arm_msd': if(weakArmSide===null){ setItemResult('arm_msd_res',"S√≠","No",true); } else setItemResult('arm_msd_res',"S√≠","No", weakArmSide!=='MSD'); break;
    case 'arm_msi': if(weakArmSide===null){ setItemResult('arm_msi_res',"S√≠","No",true); } else setItemResult('arm_msi_res',"S√≠","No", weakArmSide!=='MSI'); break;
    case 'leg_mid': if(weakLegSide===null){ setItemResult('leg_mid_res',"S√≠","No",true); } else setItemResult('leg_mid_res',"S√≠","No", weakLegSide!=='MID'); break;
    case 'leg_mii': if(weakLegSide===null){ setItemResult('leg_mii_res',"S√≠","No",true); } else setItemResult('leg_mii_res',"S√≠","No", weakLegSide!=='MII'); break;
    case 'gaze': setItemResult('gaze_res',"S√≠","No", currentCase.md.gaze===0 ? false : true); break;
    case 'obey':
      setItemResult('obey_res',"S√≠","No", currentCase.md.noObey===1 ? false : true);
      if(currentCase.md.noObey===1){ const r=document.getElementById('recognize_res'); r.textContent="No valorable (no obedece)"; r.className="text-gray-600 italic"; }
      else { document.getElementById('recognize_res').textContent=""; document.getElementById('recognize_res').className="text-sm"; }
      break;
    case 'recognize':
      if(currentCase.md.noObey===1){ const r=document.getElementById('recognize_res'); r.textContent="No valorable (no obedece)"; r.className="text-gray-600 italic"; }
      else { setItemResult('recognize_res',"S√≠","No", currentCase.md.recNo===1 ? false : true); }
      break;
  }
}

/* ======= Eventos ======= */
function seleccionarRol(r){ role=r; document.getElementById("rolActual").textContent = (role==='lider'?'L√≠der':'Mandao'); document.getElementById("btnMovilizar").disabled=false; }
function iniciarSimulacion(){
  document.getElementById("cronometro").classList.remove("hidden");
  document.getElementById("emojiPanel").classList.remove("hidden");
  iniciarCronometro();
  if(role==='lider'){ document.getElementById("mdNumericSection").classList.remove("hidden"); document.getElementById("decisionesSection").classList.remove("hidden"); }
  else { document.getElementById("mdNumericSection").classList.add("hidden"); document.getElementById("decisionesSection").classList.add("hidden"); }
}
function validarMadrid(){
  const valStr=document.getElementById("inputMadrid").value, msg=document.getElementById("msgMadrid");
  if(valStr===""){ msg.textContent="Introduce una puntuaci√≥n."; msg.className="text-red-700 font-semibold text-lg"; return; }
  const val=Number(valStr);
  if(val===correctMadrid){ msg.textContent="C√°lculo correcto ‚úî"; msg.className="text-green-700 font-semibold text-lg"; }
  else { msg.textContent="Incorrecto ‚úò. Revisa tu exploraci√≥n."; msg.className="text-red-700 font-semibold text-lg"; }
}

/* Decisiones (L√≠der) */
function showGameOver(msg){ pararCronometro(); document.getElementById("goMsg").textContent = msg||"Has fallado en la decisi√≥n."; document.getElementById("gameOverOverlay").style.display="flex"; }
function showSuccess(){ pararCronometro(); document.getElementById("okMsg").textContent = "Tiempo total: " + document.getElementById("tiempo").textContent; document.getElementById("successOverlay").style.display="flex"; }
function decideCumple(){ if(currentCase.cumpleCodigo){ document.getElementById("btnAlerta").classList.remove("hidden"); document.getElementById("msgMadrid").textContent="Ahora gestiona la Alerta hospitalaria para finalizar."; document.getElementById("msgMadrid").className="text-slate-700 text-sm"; } else { showGameOver("El caso NO cumpl√≠a criterios. Decisi√≥n incorrecta."); } }
function decideNoCumple(){ if(!currentCase.cumpleCodigo){ showSuccess(); } else { showGameOver("El caso S√ç cumpl√≠a criterios. Decisi√≥n incorrecta."); } }
function gestionarAlerta(){ segundos+=300; actualizarTiempo(); flashTiempo(); if(currentCase.cumpleCodigo){ document.getElementById("destinoHospital").classList.remove("hidden"); document.getElementById("textoDestino").textContent=`Destino: ${currentCase.destino}`; } showSuccess(); }

/* Flujo de casos */
function siguienteCaso(){
  hideOverlays();               /* <- Oculta overlays ANTES de pasar de caso */
  caseIndex++;
  if(caseIndex>casos.length) caseIndex=1;
  LS.saveCase();
  bootCase();
}

/* Selector de caso */
function buildCasePicker(){
  const picker=document.getElementById("casePicker");
  picker.innerHTML=""; casos.forEach(c=>{ const opt=document.createElement("option"); opt.value=c.numero; opt.textContent=`Caso #${c.numero}`; picker.appendChild(opt); });
  picker.addEventListener("change", ()=>{ caseIndex=parseInt(picker.value,10); if(isNaN(caseIndex)||caseIndex<1||caseIndex>casos.length) caseIndex=1; LS.saveCase(); bootCase(); });
}

/* Boot de caso */
function bootCase(){ setCaseNumberDisplay(); resetUI(); seleccionarCasoActual(); }

/* DOM Ready */
window.addEventListener("DOMContentLoaded", ()=>{
  buildCasePicker();
  LS.loadCase();
  setCaseNumberDisplay();
  seleccionarCasoActual();

  // Selecci√≥n de rol
  document.getElementById("btnRolLider").addEventListener("click", ()=> seleccionarRol('lider'));
  document.getElementById("btnRolMandao").addEventListener("click", ()=> seleccionarRol('mandao'));

  // Inicio (ambulancia)
  document.getElementById("btnMovilizar").addEventListener("click", iniciarSimulacion);

  // Emojis
  document.getElementById("btnClinica").addEventListener("click", onClinica);
  document.getElementById("btnConstantes").addEventListener("click", onConstantes);
  document.getElementById("btnAntecedentes").addEventListener("click", onAntecedentes);
  document.getElementById("btnHora").addEventListener("click", onHora);

  // √çtems MD (Mandao)
  document.querySelectorAll("[data-check]").forEach(btn=> btn.addEventListener("click",()=> handleCheck(btn.getAttribute("data-check"))));

  // Num√©rico MD (L√≠der)
  document.getElementById("btnValidarMadrid").addEventListener("click", validarMadrid);

  // Decisiones
  document.getElementById("btnCumple").addEventListener("click", decideCumple);
  document.getElementById("btnNoCumple").addEventListener("click", decideNoCumple);

  // Alerta
  document.getElementById("btnAlerta").addEventListener("click", gestionarAlerta);

  // Overlays ‚Üí siguiente caso
  document.getElementById("btnSiguienteGO").addEventListener("click", siguienteCaso);
  document.getElementById("btnSiguienteOK").addEventListener("click", siguienteCaso);
});
</script>
</body>
</html>